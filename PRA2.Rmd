---
title: 'Pràctica 2: Com Realitzar la neteja i l'anàlisi de dades?'
author: "Esther Manzano i Albert Queraltó"
date: '`r format(Sys.Date(),"%e de %B %Y")`'
output:
  html_document:
    highlight: default
    number_sections: yes
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
---

# LLibreries

Primer de tot, carregarem algunes llibreries que podríem necessitar per crear els diferents models, analitzar-los i generar gràfics.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem les llibreries utilitzades per fer l'anàlisi exploratòria de les dades
library(ggplot2)
library(plyr)
library(dplyr)
library(stats)
library(lmtest)
library(tidyverse)
library(caret)
library(scales)
library(gridExtra)
library(grid)
library(corrplot)
library(RColorBrewer)
library(reshape2)
library(ggpubr)
library(Hmisc)
library(PerformanceAnalytics)
library(arulesCBA)
library(arules)
library(arulesViz)
library(factoextra)
library(randomForest)
library(rpart)
library(rpart.plot)
library(cluster)
library(factoextra)
library(useful)
library(GGally)
library(flexclust)
library(clValid)
library(NbClust)
library(ROCR)
library(precrec)
library(e1071)
library(knitr)
library(lubridate)
library(stringr)
library(psych)
library(pROC)
library(xfun)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Descripció del dataset

En els últims mesos, l'evolució del preu de l'energia elèctrica ha augmentat considerablement degut a la pujada dels preus dels combustibles fòssils, a la guerra d'Ucraïna i
a l'especulació dels mercats. [1, 2] Això ha provocat una situació d'inflació insostenible per a moltes famílies i comerços, i ha posat de nou les energies renovables en el centre de la
política energètica amb l'objectiu de reduir la dependència dels combustibles fòssils i redreçar la situació. [1-3] El preu de l'energia d'origen renovable ha disminuït
considerablement en els últims anys si es compara amb altres fonts d'energia no renovables, com el gas natural o el carbó. [4] A més, hi ha una necessitat creixent de reduir la
producció d'energia a partir de combustibles fòssils per a reduir les emissions de gasos d'efecte hivernacle a l'atmosfera i frenar el canvi climàtic. [5]

Per aquest motiu i amb l'objectiu de promoure la producció d'energia renovable, es vol analitzar l'evolució del preu de l'energia elèctrica a Espanya i la producció d'energies
renovables en el període de temps comprès entre l'1 de Novembre del 2020 al 31 d'Octubre del 2022. Aquesta informació, recopilada en la pràctica 1 fent servir webscraping a partir 
de les dades obtingudes de la web https://www.esios.ree.es/es/, [6-7] ens permetrà:

- Analitzar l'evolució del preu de l'energia elèctrica a Espanya en el període de temps mencionat.
- Entendre la relació entre el preu de l'energia elèctrica i la producció d'energies renovables.
- Discernir quina font d'energia renovable té un impacte més rellevant en el preu de l'energia.
- Predir el preu de l'energia elèctrica a Espanya en funció de la producció d'energia renovable.

### Cal afegir descripció del dataset AEMET
#### Què més podem afegir? Mirar d'ampliar una mica. 
#### A part de les anàlisis que ens demanen, jo miraria de fer algun model senzill per predir el preu de l'energia elèctrica a partir de la producció d'energia renovable.



# 2. Integració i selecció

## 2.1. Càrrega, preprocessat i selecció del dataset ESIOS

### 2.1.1. Càrrega de les dades i anàlisi a alt nivell

Carreguem les dades del dataset ESIOS que hem creat a la pràctica 1 en un dataframe. 
Aquestes dades són les obtingudes a partir de la web https://www.esios.ree.es/es/ 
[6-7] i contenen la informació de l'evolució del preu de l'energia elèctrica a 
Espanya i la producció d'energies renovables en el període de temps comprès entre 
l'1 de Novembre del 2020 al 31 d'Octubre del 2022.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem els datasets en un dataframe
esios_dataset <- read.csv('data/esios_dataset.csv', header = TRUE, sep=";")

```

Renombrem les columnes del dataset per a que siguin més fàcils de tractar.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Renombrem el nom de les columnes
colnames(esios_dataset) <- c("date", "hour", "avg_total_price_eur_mwh", 
                              "avg_price_free_market_eur_mwh", 
                              "avg_price_ref_market_eur_mwh", "energy_total_mwh", 
                              "energy_free_market_mwh", "energy_ref_market_mwh",
                              "free_market_share_perc", "ref_market_share_perc", 
                              "renewable_generation_perc", "energy_source", 
                              "renewable_generation_mw")
                              
# Mostrem les primeres files del dataset
head(esios_dataset)

# Mostrem les dimensions del dataset
dim(esios_dataset)
```

Com podem veure, el dataset conté 13 columnes i 105120 files. Tot seguit, 
comprovem el tipus de dades de cada columna del dataset:
  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Verifiquem el tipus de dades de cada columna del dataset
sapply(esios_dataset, class)
```

Es pot veure com totes les columnes són de tipus "character", malgrat que la 
majoria d'elles haurien de ser de tipus numèric. Caldrà fer un preprocessat previ 
per poder tractar-les com a numèriques. A més, també es preprocessaran les 
columnes "date" i "hour" per a poder tractar-les com a dates, com també la 
columna "energy_source".

### 2.1.2. Processat de la columna "energy_source" i transformació a factor

Tractem els valors de la columna "energy_source" per a que tinguin un nom adequat. 
És a dir, substituïm els valors de la columna "energy_source" pels següents noms:
- "renewable generation (MW)" per "total".
- "wind generation (MW)" per "wind".
- "water generation (MW)" per "hydroelectric".
- "solar generation (MW)" per "solar".
- "nuclear generation (MW)" per "nuclear".
- "thermorenewable generation (MW)" per "thermorenewable".

```{r echo=TRUE, message=FALSE, warning=FALSE}

# Substituïm els valors de la columna "energy_source"
esios_dataset$energy_source <- gsub("thermorenewable generation (MW)", 
                                    "thermorenewable", 
                                    esios_dataset$energy_source, fixed = TRUE)
esios_dataset$energy_source <- gsub("renewable generation (MW)", 
                                    "total", 
                                    esios_dataset$energy_source, fixed = TRUE)
esios_dataset$energy_source <- gsub("wind generation (MW)", 
                                    "wind", 
                                    esios_dataset$energy_source, fixed = TRUE)
esios_dataset$energy_source <- gsub("water generation (MW)", 
                                    "hydroelectric", 
                                    esios_dataset$energy_source, fixed = TRUE)
esios_dataset$energy_source <- gsub("solar generation (MW)", 
                                    "solar", 
                                    esios_dataset$energy_source, fixed = TRUE)
esios_dataset$energy_source <- gsub("nuclear generation (MW)", 
                                    "nuclear", 
                                    esios_dataset$energy_source, fixed = TRUE)

# Mostrem els valors de la columna "energy_source"
unique(esios_dataset$energy_source)
```

A continuació, transformem la columna "energy_source" a tipus factor.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Transformem la columna "energy_source" a tipus factor
esios_dataset$energy_source <- as.factor(esios_dataset$energy_source)

# Verifiquem el tipus de dades de cada columna del dataset
sapply(esios_dataset, class)
```

### 2.1.3. Processat de la columnes "renewable_generation_perc" i "renewable_generation_mw"

Les columnes "renewable_generation_perc" i "renewable_generation_mw" contenen 
les unitats (% i MW) juntament amb el valor numèric i caldrà eliminar aquests 
strings per a poder tractar-les com a numèriques. També eliminarem el salt de 
línia ("\n") de la columna "renewable_generation_perc".

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Eliminem les unitats de les columnes "renewable_generation_perc" i "renewable_generation_mw"
esios_dataset$renewable_generation_perc <- gsub("%", "", 
                                        esios_dataset$renewable_generation_perc)
esios_dataset$renewable_generation_mw <- gsub("MW", "", 
                                        esios_dataset$renewable_generation_mw)

# Eliminem els "\n" de la columna "renewable_generation_perc"
esios_dataset$renewable_generation_perc <- gsub("\n", "", 
                                        esios_dataset$renewable_generation_perc)

# Eliminem els espais en blanc de totes les columnes
esios_dataset <- esios_dataset %>% 
  mutate_at(vars(date, hour, energy_source), funs(gsub(" ", "", .)))

# Mostrem les primeres files del dataset
head(esios_dataset)
```

### 2.1.4 Processat dels separadors decimals i de milers, i transformació a columnes numèriques

Eliminem els separadors de milers de les columnes numèriques i substituïm els 
separadors decimals per un punt.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Eliminem els separadors de milers de les columnes numèriques
esios_dataset <- esios_dataset %>% 
  mutate_at(vars(energy_total_mwh, energy_ref_market_mwh, 
  energy_free_market_mwh, renewable_generation_mw), funs(gsub(".", "", ., 
                                                                fixed = TRUE)))

# Eliminem els separadors de milers de les columnes numèriques
esios_dataset <- esios_dataset %>% 
  mutate_at(vars(avg_total_price_eur_mwh, avg_price_ref_market_eur_mwh, 
  avg_price_free_market_eur_mwh, energy_total_mwh, energy_ref_market_mwh, 
  energy_free_market_mwh, free_market_share_perc, ref_market_share_perc,
  renewable_generation_perc), funs(gsub(",", ".", ., fixed = TRUE)))

# Mostrem les primeres files del dataset
head(esios_dataset)
```

Finalment, transformem les columnes que haurien de ser numèriques a aquest tipus.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Transformem les columnes numèriques a tipus numèric
esios_dataset <- esios_dataset %>% 
  mutate_at(vars(avg_total_price_eur_mwh, avg_price_ref_market_eur_mwh, 
  avg_price_free_market_eur_mwh, energy_total_mwh, energy_ref_market_mwh, 
  energy_free_market_mwh, free_market_share_perc, ref_market_share_perc,
  renewable_generation_perc, renewable_generation_mw), funs(as.numeric(.)))
```

Es pot veure com durant la transformació hi ha alguns valors nuls que haurem de 
tractar posteriorment. Finalment, comprovem el tipus de dades de cada columna 
del dataset.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Verifiquem el tipus de dades de cada columna del dataset
sapply(esios_dataset, class)

# Mostrem les primeres files del dataset
head(esios_dataset)
```

### 2.1.5. Calculem el promig de totes les columnes numèriques

Calculem el promig de totes les columnes numèriques del dataset tenint en compte
els valors de les columnes *date* i *energy_source*. El promig es calcula perquè
el dataset AEMET que tractarem posteriorment té una granularitat menor, és a dir,
les dades estan agrupades per dia.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculem el promig de totes les columnes numèriques del dataset
esios_dataset <- esios_dataset %>% 
  group_by(date, energy_source) %>% 
  summarise_all(funs(mean(., na.rm = FALSE)))

# Mostrem les primeres files del dataset
head(esios_dataset)
```

Mostrem l'histograma de la columnes numèriques en funció de la data

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Mostrem l'histograma de la columnes numèriques en funció de la data
esios_dataset %>% 
  group_by(date) %>% 
  summarise_all(funs(mean(., na.rm = FALSE))) %>% 
  gather(key = "variable", value = "value", -date) %>% 
  ggplot(aes(x = date, y = value, fill = variable)) + 
  geom_col(position = "dodge") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  labs(title = "Histograma de les columnes numèriques en funció de la data", 
        x = "Data", y = "Valor")
```


### 2.1.6. Eliminem les columnes que no ens interessin


<!-- Combinació de les columnes "date" i "hour" i tranformació a tipus "datetime" -->

A continuació, es combinen les columnes "date" i "hour" en una sola columna 
"datetime" i es transforma a tipus "datetime".

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Combinar les columnes "date" i "hour" en una sola columna "datetime"
esios_dataset <- esios_dataset %>% 
  mutate(datetime = paste(date, hour, sep = " "))

# Transformar la columna "datetime" a tipus "datetime"
esios_dataset <- esios_dataset %>% 
  mutate(datetime = as.POSIXct(datetime, format = "%Y-%m-%d %H:%M"))

# Comprovem que les columnes han estat transformades correctament
head(esios_dataset)
tail(esios_dataset)
```

Finalment, eliminarem les columnes "date" i "hour" ja que ja no ens seran útils.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Eliminem les columnes "date" i "hour"
esios_dataset <- esios_dataset %>% 
  select(-date, -hour)
```

Comprovem que les columnes han estat eliminades correctament.

#### Nota: en fer aquest pas, la columna datetime perd el valor de l'hora per les 00:00:00. Cal mirar-ho. Potser és cosa del meu IDE.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Comprovem que les columnes han estat eliminades correctament
tail(esios_dataset)
```



## 2.2. Càrrega, preprocessat i selecció del dataset AEMET


# 3. Neteja de les dades

Abans de procedir a la gestió  de valors buits i extrems, 






## 3.5. Gestió de zeros o valors buits

Comprovem si hi ha valors nuls.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Comprovem si hi ha valors nuls
sum(is.na(esios_dataset))
```


## 3.2. Identificació i gestió de valors extrems


# 4. Anàlisi de les dades

## 4.1. Selecció dels grups de dades a analitzar i tipus d'anàlisis que es portaran a terme

## 4.2. Comprovació de la normalitat i homogeneïtat de la variància

## 4.3. Proves estadístiques per comparar grups de dades (Almenys 3 mètodes d'anàlisi diferents)



# Referències

[1] Alexis Romero, "La guerra a Ucraïna i la creixent inflació ressusciten el debat sobre la intervenció del mercat elèctric" (Público, 01/03/2022). 
https://www.publico.es/public/encariment-preus-guerra-ucraina-i-creixent-inflacio-ressusciten-debat-intervencio-mercat-electric.html

[2] Vicenç Batalla, "La UE frenarà la pujada de l'electricitat per la guerra" (El Punt Avui, 12/03/2022).
https://www.elpuntavui.cat/politica/article/17-politica/2111814-la-ue-frenara-la-pujada-de-l-electricitat-per-la-guerra.html

[3] elnacional.cat, "La situació actual de les energies renovables a Catalunya: què tenim i cap on anem?" (El Nacional, 06/06/2022).
https://www.elnacional.cat/ca/branded/energies-renovables-catalunya-cap-anem_685709_102.html

[4] Ourworldindata.org, "La caiguda del preu de l'electricitat a partir de fonts renovables" (Ourworldindata.org, 2022).
https://ca.dsnsolar.com/info/the-price-decline-of-electricity-from-renewabl-70291585.html

[5] naciodigital.cat, "Tindrem prou energia només amb les renovables?" (Nació Digital, 2022).
https://www.naciodigital.cat/noticia/230097/canvi-climatic-tindrem-prou-energia-nomes-renovables

[6] Esther Manzano i Albert Queraltó, "Webscraping of Energy Prices and Renewable Energy Production" (GitHub, 2022).
https://github.com/albert-queralto/scraping-energy-prices-spain

[7] Esther Manzano i Albert Queraltó, "Evolution of the price of electricity and the renewable energy production in Spain" (Zenodo, 2022).
https://doi.org/10.5281/zenodo.7335618