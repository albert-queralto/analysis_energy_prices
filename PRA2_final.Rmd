---
title: "Pràctica 2: Com realitzar la neteja i l'anàlisi de dades?"
subtitle: "Document d'entrega"
author: "Esther Manzano i Albert Queraltó"
date: '`r format(Sys.Date(),"%e de %B %Y")`'
output:
  pdf_document:
    toc: yes
  html_document:
    highlight: default
    number_sections: yes
    toc: yes
    toc_depth: 2
fontsize: 11pt
---

# LLibreries

Primer de tot, carregarem algunes llibreries que podríem necessitar per crear els diferents models, analitzar-los i generar gràfics.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Instal·lem i/o carreguem les llibreries utilitzades per fer l'anàlisi exploratòria de les dades
packages <- c("ggplot2", "plyr", "dplyr", "stats", "lmtest", "tidyverse", "caret", "corrplot", "Hmisc", "rpart", "rpart.plot", "useful", "ROCR", "precrec", "knitr", "lubridate", "stringr", "psych", "pROC", "zoo", "reshape2", "gridExtra", "ggpubr", "rstatix", "lattice")

# install.packages(packages) # Comentar si no cal instal·lar les llibreries 
lapply(packages, require, character.only = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Descripció del dataset

En els últims mesos, l'evolució del preu de l'energia elèctrica ha augmentat considerablement degut a la pujada dels preus dels combustibles fòssils, a la guerra d'Ucraïna i a l'especulació dels mercats. [1, 2] Això ha provocat una situació d'inflació insostenible per a moltes famílies i comerços, i ha posat de nou les energies renovables en el centre de la política energètica amb l'objectiu de reduir la dependència dels combustibles fòssils i redreçar la situació. [1-3] 
El preu de l'energia d'origen renovable ha disminuït considerablement en els últims anys si es compara amb altres fonts d'energia no renovables, com el gas natural o el carbó. [4] A més, hi ha una necessitat creixent de reduir la producció d'energia a partir de combustibles fòssils per a reduir les emissions de gasos d'efecte hivernacle a l'atmosfera i frenar el canvi climàtic. [5]

Per aquest motiu i amb l'objectiu de promoure la producció i utilització de l'energia renovable, es vol analitzar l'evolució del preu de l'energia elèctrica a Espanya i la producció general d'energies renovables en el període de temps comprès entre l'1 de Novembre del 2020 al 31 d'Octubre del 2022 en la mateixa zona geogràfica. 

Aquesta informació es va recopilar en la primera pràctica mitjançant la tècnica de webscraping a partir de les dades obtingudes de la web https://www.esios.ree.es/es/ (*dataset ESIOS*), per a la qual es va demanar permís explícit per a tractar i publicar el resultat obtingut amb aquestes dades. El resultat de la primera pràctica es pot trobar publicat a: https://github.com/albert-queralto/scraping-energy-prices-spain [6-7] 

D'altra banda, cal mencionar també com la meteorologia influeix significativament en la producció de les energies renovables. Per exemple, es preveu que els dies assolellats tinguin una elevada producció d'origen fotovoltaïc, així com l'energia eòlica serà representativa en els dies ventosos o la quantitat de precipitació contribuirà a omplir els embassaments que permeten generar energia hidroelèctrica. 

Així doncs, per completar l'anàlisi, també s'ha decidit utilitzar dades climàtiques diàries obtingudes de la web https://opendata.aemet.es/ (*dataset AEMET*). Entre altres, hi ha dades de temperatures, precipitació, vent, insolació, etc., 
en el mateix rang de dates que el dataset d'ESIOS. La combinació d'ambdós datasets ens permetrà assolir els objectius següents marcats per a aquesta pràctica:

- Analitzar l'evolució del preu de l'energia elèctrica a Espanya en el període de temps mencionat.
- Entendre la relació entre el preu de l'energia elèctrica, la producció d'energies renovables i la influència de la meteorologia.
- Discernir quina font d'energia renovable té un impacte més rellevant en el preu de l'energia.
- Predir el preu de l'energia elèctrica a Espanya en funció de la producció d'energia renovable.

# 2. Integració i selecció

Degut a l'extensió del preprocessat, aquest s'ha dut a terme en un fitxer a part (*PRA2_preprocessing.Rmd*). En aquest document, només es mostra la integració i selecció de les dades.

## 2.1. Càrrega i selecció del dataset ESIOS

### 2.1.1. Càrrega de les dades i anàlisi a alt nivell

Carreguem les dades del *dataset ESIOS* creat a la pràctica 1 i preprocessat (veure *PRA2_preprocessing.Rmd*). Aquestes dades són les obtingudes a partir de la web https://www.esios.ree.es/es/ [6-7] i contenen la informació de l'evolució del preu de l'energia elèctrica a Espanya i la producció d'energies renovables en el període de temps comprès entre l'1 de Novembre del 2020 al 31 d'Octubre del 2022. Aquest dataset tenia una granularitat per hores. Tanmateix, el *dataset AEMET* contené dades per dia, per això, s'han calculat els promitjos diaris de les dades del *dataset ESIOS*. Per fer aquest càlcul, s'han hagut de tractar també els valors nuls, ja què si no, el promig diari no es podia calcular correctament. La imputació de valors nuls, tot i què aquests eren menys d'un 0.1% de les dades, s'ha fet interpolant les dades agrupades per la variable *energy_source*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem els datasets en un dataframe
esios_dataset <- read.csv('data/esios_dataset_preprocessed.csv', header = TRUE, sep=",")

# Transformem les columnes date, energy_source i renewable_generation_perc_bin al format correcte
esios_dataset$date <- as.Date(esios_dataset$date, format = "%Y-%m-%d")
esios_dataset <- esios_dataset %>% 
  mutate_at(vars(energy_source, renewable_generation_perc_bin), funs(as.factor(.)))

# Taula resum que representa les principals característiques de les diferents variables
str(esios_dataset)
```

El dataset conté dades estructurades en 13 columnes i 4380 files. Les columnes *date*, *energy_source* i *renewable_generation_perc_bin* eren de tipus *character* i s'han transformat al tipus correcte (*Date* i *factor*).

### 2.1.2. Filtrat de variables numèriques

Filtrem les variables numèriques fent servir una matriu de correlació:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
# Calculem la matriu de correlació
corr_vars_esios <- c("avg_total_price_eur_mwh", "avg_price_free_market_eur_mwh", "avg_price_ref_market_eur_mwh", "energy_free_market_mwh",
                    "energy_ref_market_mwh", "energy_total_mwh", "free_market_share_perc", "ref_market_share_perc", "renewable_generation_mw", "renewable_generation_perc")
corr_matrix_esios <- cor(esios_dataset[, corr_vars_esios], use='complete.obs', method=c("pearson"))

# Representem gràficament la matriu de correlació
corrplot(corr_matrix_esios, method = "circle", type = "lower", 
          tl.col = "black", tl.srt = 45, tl.cex = 0.5)
```

Les variables *avg_price_free_market_eur_mwh*, *avg_price_ref_market_eur_mwh* i *avg_total_price_eur_mwh* tenen una elevada correlació, per això només conservarem la darrera. Pel que fa a les variables *free_market_share_perc*, *ref_market_share_perc*, *energy_free_market_mwh* i *energy_ref_market_mwh*, s'ha decidit eliminar-les ja que s'ha considerat que no aporten informació rellevant per a l'estudi proposat. Les variables *renewable_generation_mw* i *renewable_generation_perc* també estan fortament correlacionades i només conservarem la segona. Així doncs, les columnes que es volen conservar són: *date*, *avg_total_price_eur_mwh*, *energy_total_mwh*, *energy_source*, *renewable_generation_perc* i *renewable_generation_perc_bin*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Filtrem les columnes que no ens interessin
esios_dataset <- esios_dataset %>% 
  select(date, avg_total_price_eur_mwh, energy_total_mwh, energy_source, renewable_generation_perc, renewable_generation_perc_bin)

# Mostrem les primeres files del dataset
head(esios_dataset)
```

### 2.1.10. Representem les variables resultants

Representem les variables numèriques del dataset resultant en diferents histogrames i les categòriques en gràfics de barres:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=2.5, fig.width=14}
# Histograma de les variables numèriques
total_price_hist <- ggplot(esios_dataset, aes(x = avg_total_price_eur_mwh)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "avg_total_price_eur_mwh", 
        x = "Avg total price (€/MWh)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

energy_total_hist <- ggplot(esios_dataset, aes(x = energy_total_mwh)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "energy_total_mwh", 
        x = "Energy total (MWh)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

renew_perc_hist <- ggplot(esios_dataset, aes(x = renewable_generation_perc)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "renewable_generation_perc", 
        x = "Renewable generation (%)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

# Barplot per renewable_generation_perc_bin en funció de energy_source
energy_source_data <- esios_dataset %>% filter(energy_source != "total")
renew_perc_bin_bar <- ggplot(energy_source_data, aes(x = renewable_generation_perc_bin, fill = energy_source)) + geom_bar(alpha=0.7) + 
  scale_fill_brewer(palette="Spectral") +
  labs(x = "Intervals de generació renovable", 
        y = "Freqüència") + 
  theme_bw() + theme(text = element_text(size = 11))

grid.arrange(total_price_hist, energy_total_hist, renew_perc_hist, renew_perc_bin_bar, ncol = 4)
```

Observem que la variable *renewable_generation_perc* té freqüència més alta al voltant del 5% (~800 MW), mentre què aquesta freqüència disminueix a mesura que augmenta la potència renovable, essent gairebé nul·la en valors del 100% (~30000 MW). Això indicaria que la producció renovable és normalment baixa, entre el 0 i el 25%. L'*avg_total_price_eur_mwh* presenta dues distribucions, la primera amb un màxim entorn a 100 MW i la segona amb un màxim al voltant de 200 MW. Això indicaria la presència de períodes amb dos rangs de preus molt diferents. La variable *energy_total_mwh* presenta una distribució lleugerament esbiaxada cap a l'esquerra amb un màxim de freqüència entorn els 28000 MWh. Pel que fa al gràfic de barres d'*renewable_generation_perc_bin*, la majoria d'observacions tenen un percentatge de generació entre el 0% i el 35% amb una representació bastant semblant per les diferents fonts d'energia. Per tant, es pot concloure que la generació renovable es troba normalment per sota del 35%. Pel que fa a l'energia eòlica, s'observen també algunes observacions en el rang del 36% al 75%, essent la font d'energia que més contribueix a la producció renovable. D'altra banda, l'energia hidroelèctrica consumeix energia en alguns casos.

Representem la sèrie temporal de les mateixes variables numèriques:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=2, fig.width=14}
# Serie temporal de les variables avg_total_price_eur_mwh, energy_total_mwh, renewable_generation_mw i renewable_generation_perc
total_price_plot <- ggplot(esios_dataset, aes(x = date, y = avg_total_price_eur_mwh)) + geom_line() + labs(title = "avg_total_price_eur_mwh", 
        x = "Date", y = "Avg total price (€/MWh)") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 10))

energy_total_plot <- ggplot(esios_dataset, aes(x = date, y = energy_total_mwh)) + geom_line() + labs(title = "energy_total_mwh",
        x = "Date", y = "Energy total (MWh)") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 10))

renewable_generation_perc_plot <- ggplot(esios_dataset, aes(x = date, y = renewable_generation_perc, color = energy_source)) + geom_line() + labs(title = "renewable_generation_perc",
        x = "Date", y = "Renewable generation (%)") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 10))

grid.arrange(total_price_plot, energy_total_plot, renewable_generation_perc_plot, ncol = 3)
```

La presència de les dues distribucions per *avg_total_price_eur_mwh* es veu clarament ja que els preus eren més propers als 100 €/MWh per l'any 2021, mentre què aquests van pujar entorn els 200 €/MWh al 2022. L'evolució de *energy_total_mwh* mostra que la producció a Espanya es situa entre els 22000 i els 32000 MW, aproximadament. Pel que fa a les energies lliures de CO2, l'energia eòlica i la nuclear predominen en la producció. Malgtrat això, la solar també a vist un agument en els darrers mesos del 2022. La disminució de la producció hidroelèctrica pot estar ocasionada per la sequera extrema que estem vivint actualment, mentre què la producció termorenovable no té una representació gaire significativa.

## 2.2. Càrrega i selecció del dataset AEMET

### 2.2.1. Càrrega de les dades i anàlisi a alt nivell

Carreguem les dades del *dataset AEMET* preprocessat (veure *PRA2_preprocessing.Rmd*). Aquestes dades s'han obtingut de la web https://opendata.aemet.es/ utilitzant l'API proporcionada. La informació continguda al dataset va des de l'1 d'Octubre del 2020 al 30 de Novembre del 2022. Aquest estava format per la data d'adquisició dels registres, el número identificador de l'estació meteorològica, el seu nom, la provincia, l'altitud sobre el nivell del mar (en metres), la temperatura mitjana diària (ºC), la precipitació diària (en mm), la temperatura mínima (ºC), l'hora i minuts d'adquisició de la temperatura mínima, la temperatura màxima (ºC), l'hora i minuts d'adquisició de la temperatura màxima, la direcció de la ratxa de vent màxima, la velocitat mitjana del vent (m/s), l'hora de la ratxa màxima, l'insolació (en hores), la pressió màxima (hPa), l'hora de la pressió màxima, la pressió mínima (hPa), l'hora de la pressió mínima.

La presència de diverses estacions meteorològiques per província ha requerit el càlcul dels promitjos diares per província per tal de simplificar les dades. Per fer aquest càlcul, s'han hagut de tractar també els valors nuls durant el preprocessat, ja què si no, el promig diari no es podia calcular correctament. La imputació de valors nuls s'ha fet interpolant les dades agrupades per la variable *province*. A més, també s'ha decidit eliminar les columnes *climate_indicator*, *station_name*, *hour_min_temp*, *hour_max_temp*, *hour_max_wind_speed*, *hour_max_pressure* i *hour_min_pressure* durant el preprocessat ja que la informació aportada no era rellevant pel nostre anàlisi. També, s'ha creat la variable *avg_pressure* a partir de les variables *max_pressure* i *min_pressure*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Carreguem les dades del dataset AEMET preprocessat
aemet_dataset <- read.csv("data/aemet_dataset_preprocessed.csv", sep = ",", header = TRUE, 
                          stringsAsFactors = FALSE)

# Taula resum que representa les principals característiques de les diferents variables
str(aemet_dataset)
```

El dataset conté 16 columnes i 37960 files. Les columnes *date*, *province*, *avg_pressure_bin* i *insolation_bin* eren de tipus *character* i s'han transformat al tipus correcte (*Date* i *factor*).

### 2.2.2. Filtrat de variables numèriques

Es calcula la matriu de correlació entre les variables numèriques per veure aquelles que estan altament correlacionades i conservar-ne només una:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=3, fig.width=6}
# Calculem la matriu de correlació without NA values
corr_matrix_aemet <- cor(aemet_dataset[, c("height_above_sea", "avg_daily_temp", "daily_precipitation", "min_daily_temp", "max_daily_temp", "max_wind_direction", "avg_wind_speed", 
          "max_wind_speed", "insolation", "max_pressure", "min_pressure", "avg_pressure")], use = "complete.obs", method=c("pearson"))

# Representem gràficament la matriu de correlació
corrplot(corr_matrix_aemet, method = "circle", type = "lower", tl.col = "black", tl.srt = 20, tl.cex = 0.5)
```

Els resultats mostren com les variables *min_daily_temp* i *max_daily_temp* estan altament correlacionades amb *avg_daily_temp*, per tant, mantindrem aquesta última. Pel que fa a les variables *height_above_sea*, *max_pressure*, *min_pressure* i *avg_pressure*, aquestes també tenen una forta correlació. Per tant, mantindrem només *avg_pressure*. Finalment, també eliminarem la direcció del vent, ja què hem considerat que no és útil per la nostre anàlisis. Així doncs, les columnes que es volen conservar són: *date*, *province*, *avg_daily_temp*, *daily_precipitation*, *avg_wind_speed*, *max_wind_speed*, *insolation* i *avg_pressure*:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Filtrem les columnes que no ens interessin
aemet_dataset <- aemet_dataset %>% select(date, province, avg_daily_temp, daily_precipitation, avg_wind_speed, max_wind_speed, insolation, avg_pressure, avg_pressure_bin, insolation_bin)
```

### 2.2.3. Representem les variables resultants

Representem les variables numèriques del dataset resultant en diferents histogrames i les categòriques en gràfics de barres:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=5, fig.width=14}
# Histograma de les variables numèriques
avg_temp_hist <- ggplot(aemet_dataset, aes(x = avg_daily_temp)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "avg_daily_temp", 
        x = "Temperature (ºC)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

precipitation_hist <- ggplot(aemet_dataset, aes(x = daily_precipitation)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "daily_precipitation", 
        x = "Precipitation (mm)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

avg_wind_hist <- ggplot(aemet_dataset, aes(x = avg_wind_speed)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "avg_wind_speed", 
        x = "Avg. wind speed (km/h)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

max_wind_hist <- ggplot(aemet_dataset, aes(x = max_wind_speed)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "max_wind_speed", 
        x = "Max. wind speed (km/h)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

avg_pressure_hist <- ggplot(aemet_dataset, aes(x = avg_pressure)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "avg_pressure", 
        x = "Avg. pressure (hPa)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

insolation_hist <- ggplot(aemet_dataset, aes(x = insolation)) + geom_histogram(bins = 50, fill = c("#33CCFF"), alpha = 0.5) + labs(title = "insolation", 
        x = "Insolation (h)", y = "Freqüència") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 11))

# Barplot per avg_pressure_bin i insolation_bin
avg_pressure_bin_bar <- ggplot(aemet_dataset, aes(x = avg_pressure_bin)) + geom_bar(alpha=0.7) + 
  scale_fill_brewer(palette="Spectral") + labs(x = "Intervals de pressió atmosfèrica", 
        y = "Freqüència") + theme_bw() + theme(text = element_text(size = 11))

insolation_bin_bar <- ggplot(aemet_dataset, aes(x = insolation_bin)) + geom_bar(alpha=0.7) + 
  scale_fill_brewer(palette="Spectral") + labs(x = "Intervals d'insolació", 
        y = "Freqüència") + theme_bw() + theme(text = element_text(size = 11))

grid.arrange(avg_temp_hist, precipitation_hist, avg_wind_hist, max_wind_hist, avg_pressure_hist, insolation_hist, avg_pressure_bin_bar, insolation_bin_bar, ncol = 4)
```

# Afegir explicació del que es veu. Com és l'histograma? distribució normal, 
# biax, etc.

# avg_pressure_bin
Es pot veure que la majoria de les observacions (35000 comptes) es corresponen 
amb pressions atmosfèriques associades a la depressió. Tanmateix, això no estarà
sempre associat amb precipitació o mal temps, ja què dependrà d'altres variables
com *insolation* o *daily_precipitation*.

# insolació

Es pot veure com predominen els dies assolellats, ja que les hores d'insolació
es troben en els intervals 5-10 hores o 10+ hores. Per tant, això indica que la
pressió atmosfèrica, tot i ser un indicador d'inestabilitat meteorològica, no 
sembla suficient per determinar la insolació o la precipitació.



Representem la sèrie temporal de les mateixes variables numèriques:

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=2, fig.width=14}
# Serie temporal de les variables avg_daily_temp, daily_precipitation, avg_wind_speed, max_wind_speed, insolation i avg_pressure
total_price_plot <- ggplot(esios_dataset, aes(x = date, y = avg_total_price_eur_mwh)) + geom_line() + labs(title = "avg_total_price_eur_mwh", 
        x = "Date", y = "Avg total price (€/MWh)") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 10))

energy_total_plot <- ggplot(esios_dataset, aes(x = date, y = energy_total_mwh)) + geom_line() + labs(title = "energy_total_mwh",
        x = "Date", y = "Energy total (MWh)") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 10))

renewable_generation_perc_plot <- ggplot(esios_dataset, aes(x = date, y = renewable_generation_perc, color = energy_source)) + geom_line() + labs(title = "renewable_generation_perc",
        x = "Date", y = "Renewable generation (%)") + theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw() + theme(text = element_text(size = 10))

grid.arrange(total_price_plot, energy_total_plot, renewable_generation_perc_plot, ncol = 3)
```

avg_daily_temp, daily_precipitation, avg_wind_speed, max_wind_speed, insolation, avg_pressure


## 2.3 Unió dels dos datasets

Unim els dos datasets per tal de poder fer l'anàlisi de les dades. La columna
que utilitzarem és la data:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Unim els dos datasets
final_dataset <- left_join(esios_dataset, aemet_dataset, by = c("date"))

# Mostrem les primeres files del dataset
head(final_dataset)
```

Finalment, presentem les dimensions finals del dataset i la tipologia de columna:
  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Dimensions del dataset
dim(final_dataset)

# Tipologia de columna
sapply(final_dataset, class)

# Check null values
colSums(is.na(final_dataset))

# Resum dataset
summary(final_dataset)
```

Es pot veure com el dataset final té gairebé 228.000 files i 16 columnes.
D'aquestes, tenim una variable tipus *date*, 9 variables numèriques i 6
variables categòriques.

## 2.4 Guardar dataset final en un fitxer csv

Guardem el dataset final en un fitxer csv.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Guardem el dataset final en un fitxer csv
write.csv(final_dataset, file = "data/final_dataset.csv", row.names = FALSE)
```

# 3. Neteja de les dades

## 3.1. Gestió dels zeros o elements buits

Durant els apartats de preprocessat, ja s'ha pogut identificar que hi ha elements
buits en el dataset. Degut a la necessitat de reduir la quantitat de dades com 
també assegurar que els datasets ESIOS i AEMET tenien la mateixa granularitat per
poder-los unir, s'ha decidit tractar els valors nuls en els apartats 2.1.7 i 2.2.5.
El tractament que s'ha fet ha estat l'imputació de valors a partir de l'interpolació
lineal, ja què estem treballant amb dades temporals. Per tant, el dataset ja no
conté valors buits:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Resum dels elements buits
summary(is.na(final_dataset))
```

## 3.2. Identificació i gestió de valors extrems

Generalment, es consideren com a outliers tots aquells valors que es troben molt
lluny dels valors de la resta de la mostra. En una distribució normal, això
equival a $\pm 3\sigma$ respecte el valor promig. Per això, podem estandarditzar
les columnes numèriques i representar els boxplots:

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Creem variable amb columnes numèriques
num_vars <- c("avg_total_price_eur_mwh", "energy_total_mwh", 
              "renewable_generation_perc", "avg_daily_temp", 
              "daily_precipitation", "avg_wind_speed", 
              "max_wind_speed", "insolation", "avg_pressure")

# Subset del dataset amb les columnes numèriques sense la columna date
subset_final <- final_dataset %>% select(all_of(num_vars))
subset_final <- subset_final[,-1]

# Estandarditzem les columnes numèriques entre -1 i 1
normalized_data <- scale(subset_final, center = TRUE, scale = TRUE)

# Transposem les dades, eliminem la columna Var1 i renombrem les columnes
normalized_data <- melt(normalized_data)
normalized_data <- normalized_data[,-1]
colnames(normalized_data) <- c("Variables", "Values")

# Boxplots de les variables estandarditzades
ggplot(normalized_data, aes(y = Variables, x = Values)) +
  geom_boxplot() +
  theme_bw() +
  theme(text = element_text(size = 20))
```

A partir dels boxplots, podem veure que hi ha diferent nombre d'outliers en les
variables numèriques. En primer lloc, tenim les variables *avg_pressure* i
*insolation* que no tenen outliers. En segon lloc, tenim les variables 
*avg_daily_temp*, *renewable_generation_perc*, *energy_total_mwh* i 
*avg_total_price_eur_mwh* que tenen alguns outliers. Finalment, tenim les
columnes *max_wind_speed*, *avg_wind_speed* i *daily_precipitation* que tenen un
nombre molt elevat d'outliers, essent la darrera la variable amb més outliers.

# Faltaria descriure una mica més els motius de perquè hi pot haver outliers si hi ha espai

Tanmateix, aquestes són dades que provenen de fonts fiables. A més, les dades
d'origen meteorològic estan sotmeses a una gran aleatorietat deguda a la naturalesa
caòtica d'aquest tipus de sistemes. D'altra banda, la fluctuació de les variables
energètiques té també un alt component aleatori ja que estan influenciades per
factors externs com la meteorologia, la demanda, l'especulació dels mercats, etc. 
Per tant, la presència d'outliers no està ocasionada per registres incorrectes
sinó per la naturalesa de les dades i no els eliminarem de les nostres anàlisis.

# 4. Anàlisi de les dades

## 4.1. Selecció dels grups de dades a analitzar i tipus d'anàlisis que es portaran a terme

### 4.1.1. Anàlisi producció energia renovable en el preu de l'electricitat

Analitzarem la relació que té globalment la producció d'energia 
renovable (*renewable_generation_perc*) en el preu de l'electricitat 
(*avg_total_price_eur_mwh*). Per tant, creem un subset de les dades, filtrant
per  *energy_source=total*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Subset de les dades per energy_source = total
subset_energy_source_total <- final_dataset %>% filter(energy_source == "total")
```

### 4.1.2. ???

També analitzarem la contribució de la meteorologia en la producció d'energia
renovable. 



En segon lloc, volem conèixer quina és la relació entre *avg_daily_temp*.
*daily_precipitation*, *avg_wind_speed*, *max_wind_speed*, *insolation*,
*avg_pressure* i *energy_source* respecte *renewable_generation_perc*.
  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Tipus de variables
sapply(final_dataset, function(x) class(x))
```

### 4.1.3. ???


### 4.1.4. ???


## 4.2. Comprovació de la normalitat i homogeneïtat de la variància

### 4.2.1. Anàlisi producció energia renovable en el preu de l'electricitat

Representar QQ-plots in a grid

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Creem un grid amb els QQ-plots
grid.arrange(
  qplot(sample = subset_energy_source_total$renewable_generation_perc, 
        xlab = "renewable_generation_perc") +
        labs(title=" QQ-plot of renewable_generation_perc") +
        theme_bw() +
        theme(text = element_text(size = 20)),
  qplot(sample = subset_energy_source_total$avg_total_price_eur_mwh, 
        xlab = "avg_total_price_eur_mwh") +
        labs(title=" QQ-plot of avg_total_price_eur_mwh") +
        theme_bw() +
        theme(text = element_text(size = 20)), ncol = 2)
```

Representar QQ-plots in a grid using qqnorm and qqline

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Creem un grid amb els QQ-plots fent servir ggqqplot
# grid.arrange(
#   ggqqplot(sample = subset_energy_source_total$renewable_generation_perc, 
#            xlab = "renewable_generation_perc") +
#            labs(title=" QQ-plot of renewable_generation_perc") +
#            theme_bw() +
#            theme(text = element_text(size = 20)),
#   ggqqplot(sample = subset_energy_source_total$avg_total_price_eur_mwh, 
#            xlab = "avg_total_price_eur_mwh") +
#            labs(title=" QQ-plot of avg_total_price_eur_mwh") +
#            theme_bw() +
#            theme(text = element_text(size = 20)), ncol = 2)
```


Per comprovar la normalitat de les dades, utilitzarem el test de Shapiro-Wilk.
Aquest test ens permet comprovar si les dades provenen d'una distribució normal
o no. Per tant, si el p-value és menor que 0.05, les dades no provenen d'una
distribució normal.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Comprovem la normalitat de les dades
# shapiro.test(subset_energy_source_total$renewable_generation_perc)
# shapiro.test(subset_energy_source_total$avg_total_price_eur_mwh)
```

## 4.3. Proves estadístiques per comparar grups de dades (Almenys 3 mètodes d'anàlisi diferents)

Matriu de correlació entre *avg_daily_temp*.
*daily_precipitation*, *avg_wind_speed*, *max_wind_speed*, *insolation*,
*avg_pressure* i *renewable_generation_perc*

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculem la matriu de correlació without NA values
corr_matrix_data <- cor(final_dataset[, c("avg_daily_temp", "daily_precipitation",
          "avg_wind_speed", "max_wind_speed", "insolation", "avg_pressure",
          "renewable_generation_perc")], use = "complete.obs", 
          method=c("pearson"))

# Representem gràficament la matriu de correlació
corrplot(corr_matrix_data, method = "circle", type = "lower", 
          tl.col = "black", tl.srt = 45, tl.cex = 1.5)
```

Calculem la regressió entre les variables *avg_daily_temp*.
*daily_precipitation*, *avg_wind_speed*, *max_wind_speed*, *insolation*,
*avg_pressure*, *energy_source* i *renewable_generation_perc*.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculem la regressió lineal entre les variables
regression <- lm(renewable_generation_perc ~ avg_daily_temp + daily_precipitation + 
                  avg_wind_speed + max_wind_speed + insolation + avg_pressure + 
                  energy_source, data = final_dataset)

summary(regression)
```


# Contribucions

```{r echo=TRUE, message=FALSE, warning=FALSE}
df <- data.frame(Contribucions=rep(c('Investigació prèvia', 'Redacció de les respostes', 'Desenvolupament del codi', 'Participació al vídeo'), each=1),
                 Signatura=rep(c('Albert Queraltó, Esther Manzano', 'Albert Queraltó,     Esther Manzano', 'Albert Queraltó, Esther Manzano', 'Albert Queraltó, Esther Manzano'), times=1))

df
```


# Referències

[1] Alexis Romero, "La guerra a Ucraïna i la creixent inflació ressusciten el 
debat sobre la intervenció del mercat elèctric" (Público, 01/03/2022). 
https://www.publico.es/public/encariment-preus-guerra-ucraina-i-creixent-inflacio-ressusciten-debat-intervencio-mercat-electric.html

[2] Vicenç Batalla, "La UE frenarà la pujada de l'electricitat per la guerra" 
(El Punt Avui, 12/03/2022).
https://www.elpuntavui.cat/politica/article/17-politica/2111814-la-ue-frenara-la-pujada-de-l-electricitat-per-la-guerra.html

[3] elnacional.cat, "La situació actual de les energies renovables a Catalunya: 
què tenim i cap on anem?" (El Nacional, 06/06/2022).
https://www.elnacional.cat/ca/branded/energies-renovables-catalunya-cap-anem_685709_102.html

[4] Ourworldindata.org, "La caiguda del preu de l'electricitat a partir de fonts
renovables" (Ourworldindata.org, 2022).
https://ca.dsnsolar.com/info/the-price-decline-of-electricity-from-renewabl-70291585.html

[5] naciodigital.cat, "Tindrem prou energia només amb les renovables?" 
(Nació Digital, 2022).
https://www.naciodigital.cat/noticia/230097/canvi-climatic-tindrem-prou-energia-nomes-renovables

[6] Esther Manzano i Albert Queraltó, "Webscraping of Energy Prices and Renewable
Energy Production" (GitHub, 2022).
https://github.com/albert-queralto/scraping-energy-prices-spain

[7] Esther Manzano i Albert Queraltó, "Evolution of the price of electricity and
the renewable energy production in Spain" (Zenodo, 2022).
https://doi.org/10.5281/zenodo.7335618